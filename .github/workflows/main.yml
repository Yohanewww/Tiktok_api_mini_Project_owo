name: Automated API Tests & Docker_Image Build & Push

on:
  push:
    branches:
      - main  # ä½ çš„ä¸»åˆ†æ”¯åç§°
  pull_request:
    branches:
      - main  # ä½ çš„ä¸»åˆ†æ”¯åç§°

jobs:
  Run_Api_Test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.11.4'  # é€‰æ‹©ä½ æƒ³è¦ä½¿ç”¨çš„ Python ç‰ˆæœ¬

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Run API tests
      run: |
        # è¿è¡Œä½ çš„ API æµ‹è¯•å‘½ä»¤
        # ä¾‹å¦‚ï¼špython test.py
        python main.py & 
    - run: echo "temp deployed for api test successğŸ‰"
    
    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'  # é€‰æ‹©ä½ æƒ³è¦ä½¿ç”¨çš„ Node.js ç‰ˆæœ¬

    - name: Install Apifox CLI
      run: npm install -g apifox-cli

    - name: Running Test Scenario
      run: apifox run https://api.apifox.cn/api/v1/projects/3122443/api-test/ci-config/371736/detail?token=xprxMUsWMeDnlbJheRIxvx -r html,cli
    - run: echo "Api Test SuccessğŸ‰"
  
  Build_Docker_Image:
      runs-on: ubuntu-latest
      needs: Run_Api_Test
      steps:
        - name: Checkout
          uses: actions/checkout@v3
      
        - name: Build Docker Image
          id: build
          uses: cloudposse/github-action-docker-build-push@main
          with:
            registry: registry.hub.docker.com
            organization: "${{ github.event.repository.owner.login }}"
            repository: "${{ github.event.repository.name }}"
            login: "${{ secrets.DOCKERHUB_USERNAME }}"
            password: "${{ secrets.DOCKERHUB_PASSWORD }}"
            platforms: linux/amd64,linux/arm64
            
        - run: echo "Build Docker & Push Image SuccessğŸ‰"
      
      outputs:
        image: ${{ steps.build.outputs.image }}
        tag: ${{ steps.build.outputs.tag }}
